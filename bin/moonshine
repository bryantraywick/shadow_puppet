#!/usr/bin/env ruby
require 'moonshine'
require 'moonshine/cli'
require 'moonshine/application'

begin

  options = {}

  opts = OptionParser.new do |opts|
    opts.banner = <<-EOF
    NAME
      Moonshine

    AUTHOR
      Jesse Newland
      jesse@railsmachine.com

    DESCRIPTION
      Get that server crunk.

    EXAMPLES
      moonshine

    OPTIONS
  EOF

    opts.on("-D", "--no-daemonize", "Don't daemonize") do
      options[:daemonize] = false
    end

    opts.on("-iINTERVAL", "--interval INTERVAL", "The interval, in seconds, the daemon runs on. Defaults to 30 seconds.") do |x|
      options[:interval] = x.to_i
    end

    opts.on("-PFILE", "--pid FILE", "Where to write the pid file (/var/run/moonshine.pid)") do |x|
      options[:pid] = x
    end

    opts.on("-lFILE", "--log FILE", "Where to write the log file (/var/log/moonshine.log)") do |x|
      options[:log] = x
    end

    opts.on("--log-level LEVEL", "0 => debug, 1 => info, 2 => warn, 3 => error, 4 => fatal") do |x|
      options[:log_level] = x.to_i
    end


  end

  opts.parse!

  moonshine = Moonshine::CLI.new(options)
  moonshine.run
rescue Errno::EACCES
  puts "Please run moonshine as root"
rescue Exception => e
  if e.instance_of?(SystemExit)
    raise
  else
    puts 'Uncaught exception'
    puts e.class
    puts e.message
    puts e.backtrace.join("\n")
  end
end